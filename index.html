<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Christmas Trivia Buzzer (Online)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --cranberry: #c2185b;
      --cranberry-light: #ff5f8f;
      --evergreen: #0f9d58;
      --evergreen-dark: #0b6b3a;
      --frost: #d7f9ff;
      --gold: #ffd700;
      --plum: #3a0a3a;
      --bg: #05030c;
      --bg-soft: #0c1b26;
      --card-bg: rgba(10, 20, 30, 0.9);
      --card-border: rgba(255, 255, 255, 0.12);
      --text: #fdfdfd;
      --muted: #d7e3ea;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      color: var(--text);
      background: radial-gradient(circle at top, rgba(255, 122, 181, 0.2), transparent 55%),
        radial-gradient(circle at 20% 20%, rgba(47, 255, 198, 0.25), transparent 45%),
        linear-gradient(135deg, #05030c, #0c1b26 55%, #120018);
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .overlay {
      position: relative;
      min-height: 100vh;
      width: 100%;
      background:
        radial-gradient(circle at top, rgba(255,255,255,0.06), transparent 60%),
        linear-gradient(125deg, rgba(17, 0, 32, 0.92), rgba(0, 40, 24, 0.9));
      padding: 16px;
      overflow: hidden;
    }

    .snowfield {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }

    .snowfield::before,
    .snowfield::after {
      content: "";
      position: absolute;
      top: -100%;
      left: -25%;
      width: 150%;
      height: 200%;
      background-image:
        radial-gradient(2px 2px at 20px 30px, rgba(255, 255, 255, 0.9), transparent),
        radial-gradient(2px 2px at 80px 120px, rgba(255, 255, 255, 0.8), transparent),
        radial-gradient(3px 3px at 130px 70px, rgba(255, 255, 255, 0.75), transparent),
        radial-gradient(2px 2px at 200px 180px, rgba(255, 255, 255, 0.85), transparent),
        radial-gradient(3px 3px at 250px 20px, rgba(255, 255, 255, 0.7), transparent);
      background-size: 220px 220px;
      animation: snowfall 18s linear infinite;
      opacity: 0.7;
    }

    .snowfield::after {
      animation-duration: 28s;
      animation-direction: reverse;
      opacity: 0.5;
      transform: rotate(8deg);
    }

    @keyframes snowfall {
      0% {
        transform: translateY(0);
      }
      100% {
        transform: translateY(50%);
      }
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    /* HEADER */
    header {
      text-align: center;
      margin-bottom: 20px;
      padding: 6px 0 10px;
    }

    header h1 {
      margin: 6px 0 4px;
      font-size: 2.4rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--frost);
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
    }

    header p {
      margin: 6px auto 0;
      font-size: 1rem;
      color: var(--muted);
      max-width: 520px;
    }

    .snowflakes {
      font-size: 1.5rem;
      animation: float-snow 4s ease-in-out infinite;
    }

    @keyframes float-snow {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    /* CARDS / PANELS */
    .card,
    .login-card,
    .main-layout {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 22px;
      padding: 18px 18px 20px;
      box-shadow:
        0 18px 50px rgba(0, 0, 0, 0.65),
        0 0 0 1px rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(18px);
    }

    .login-card {
      max-width: 560px;
      margin: 32px auto 0;
    }

    .entry-wizard p {
      margin: 0 0 10px;
      font-size: 0.96rem;
      color: var(--muted);
    }

    .wizard-progress {
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding-bottom: 12px;
      margin-bottom: 18px;
    }

    .wizard-progress h2 {
      margin: 0;
      font-size: 1.2rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #fffbea;
    }

    .wizard-progress p {
      margin: 6px 0 0;
      color: rgba(255,255,255,0.7);
      font-size: 0.95rem;
    }

    .wizard-step {
      display: none;
      animation: wizardFade 260ms ease;
    }

    .wizard-step.active {
      display: block;
    }

    @keyframes wizardFade {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .wizard-name-block {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.09);
      border-radius: 16px;
      padding: 14px;
      margin-bottom: 16px;
    }

    .wizard-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media (min-width: 520px) {
      .wizard-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .wizard-card {
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      padding: 16px;
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      transition: border 0.2s ease, transform 0.12s ease, background 0.2s ease;
      text-align: left;
      width: 100%;
      color: inherit;
      font: inherit;
    }

    .wizard-card:hover {
      border-color: rgba(255,215,0,0.5);
      background: rgba(255,255,255,0.07);
      transform: translateY(-2px);
    }

    .wizard-card-title {
      display: block;
      margin: 0 0 6px;
      font-size: 1.05rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--gold);
    }

    .wizard-card-copy {
      display: block;
      color: rgba(255,255,255,0.75);
      font-size: 0.9rem;
    }

    .wizard-card .wizard-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      margin-bottom: 10px;
    }

    .wizard-card.secondary {
      border-color: rgba(255,255,255,0.08);
      background: rgba(10,40,25,0.35);
    }

    .wizard-card.secondary:hover {
      border-color: rgba(15, 157, 88, 0.7);
    }

    .wizard-card:focus-visible {
      outline: 2px solid var(--gold);
      outline-offset: 3px;
    }

    .wizard-back-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .wizard-back {
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.8);
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      opacity: 0.85;
    }

    .wizard-back:hover {
      opacity: 1;
    }

    .login-card input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.35);
      color: var(--text);
      margin-bottom: 10px;
      font-size: 1rem;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .login-card input::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .login-card input:focus {
      border-color: var(--gold);
      background: rgba(0,0,0,0.55);
      box-shadow: 0 0 0 1px rgba(255,215,0,0.5);
    }

    .field-label {
      display: block;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(255,255,255,0.7);
      margin-bottom: 6px;
    }

    .helper-text {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.75);
      margin: 8px 0 0;
    }

    .code-display {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 0.2em;
      text-align: center;
      margin: 12px 0;
      color: var(--gold);
    }

    .invite-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 0.82rem;
      margin-top: 6px;
      color: var(--muted);
    }

    .invite-chip.active {
      color: var(--gold);
      border-color: rgba(255, 215, 0, 0.5);
      background: rgba(255, 215, 0, 0.08);
    }

    .lobby-panel {
      margin-top: 18px;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.03);
      text-align: left;
    }

    .lobby-panel h3 {
      margin: 0 0 4px;
      font-size: 1.05rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--frost);
    }

    .lobby-panel p {
      margin: 0 0 12px;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.75);
    }

    .lobby-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .lobby-item {
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      gap: 14px;
      cursor: pointer;
      background: rgba(0,0,0,0.25);
      transition: border 0.15s ease, transform 0.1s ease, background 0.15s ease;
    }

    .lobby-item:hover {
      border-color: rgba(255,215,0,0.45);
      background: rgba(255,255,255,0.06);
      transform: translateY(-1px);
    }

    .lobby-code {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gold);
    }

    .lobby-meta {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.75);
    }

    .lobby-status {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      align-self: center;
    }

    .lobby-item.empty {
      justify-content: center;
      text-align: center;
      color: rgba(255,255,255,0.6);
      cursor: default;
    }

    .wizard-cta {
      margin-top: 18px;
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    .wizard-cta .btn {
      width: 100%;
    }

    .code-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .code-actions .btn {
      flex: 1;
      min-width: 140px;
    }

    .tagline {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.8);
      margin-top: 4px;
      text-align: center;
    }

    /* BUTTONS */
    .btn {
      padding: 12px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.98rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      transition:
        transform 0.08s ease,
        box-shadow 0.12s ease,
        background 0.15s ease,
        opacity 0.15s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(130deg, var(--cranberry), var(--cranberry-light));
      color: #fff;
      box-shadow: 0 8px 18px rgba(0,0,0,0.6);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--evergreen), var(--evergreen-dark));
      color: #fff;
      box-shadow: 0 6px 14px rgba(0,0,0,0.5);
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn:active:not(:disabled) {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }

    .btn + .btn {
      margin-left: 6px;
    }

    .main-layout {
      display: none;
      margin-top: 16px;
    }

    /* GRID LAYOUT */
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.35fr);
      gap: 16px;
      align-items: stretch;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* QUESTION CARD */
    .card-title {
      margin: 0 0 6px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
    }

    .question-progress {
      font-size: 0.9rem;
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .question-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 0.95rem;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .badge-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.14);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--frost);
    }

    .badge-chip[data-level="warm-up"] {
      background: rgba(15, 157, 88, 0.12);
      border-color: rgba(15, 157, 88, 0.4);
      color: #b8ffdd;
    }

    .badge-chip[data-level="tricky"] {
      background: rgba(255, 215, 0, 0.15);
      border-color: rgba(255, 215, 0, 0.55);
      color: #fff9c4;
    }

    .badge-chip[data-level="challenge"] {
      background: rgba(194, 24, 91, 0.15);
      border-color: rgba(194, 24, 91, 0.5);
      color: #ffd0e5;
    }

    .question-text {
      font-size: 1.26rem;
      margin: 8px 0 12px;
      line-height: 1.45;
    }

    .timer {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 4px;
    }

    .status {
      font-size: 0.96rem;
      margin-top: 4px;
      color: #e0f2f1;
      min-height: 1.2em;
    }

    .buzz-section {
      margin-top: 20px;
      text-align: center;
    }

    .buzz-btn {
      font-size: 1.2rem;
      padding: 16px 30px;
      width: 100%;
      max-width: 360px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.3), transparent 55%),
        linear-gradient(120deg, var(--evergreen), var(--cranberry));
      box-shadow: 0 14px 25px rgba(12, 12, 12, 0.6);
    }

    #toast {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #ffe082;
      min-height: 1.1em;
      text-align: center;
    }

    .manager-panel {
      margin-top: 14px;
      border-top: 1px dashed rgba(255,255,255,0.18);
      padding-top: 10px;
      font-size: 0.95rem;
    }

    .manager-panel h3 {
      margin: 0 0 6px;
      font-size: 1rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      opacity: 0.9;
    }

    .manager-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    /* SCOREBOARD */
    .card h2 span {
      font-size: 0.9rem;
      opacity: 0.85;
    }

    #role-banner {
      text-align: center;
      margin-bottom: 10px;
      font-size: 0.95rem;
      padding: 7px 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.12);
    }

    #role-banner::before {
      content: 'üéÑ ';
    }

    .scoreboard-list {
      list-style: none;
      padding: 0;
      margin: 8px 0 0;
      max-height: 280px;
      overflow-y: auto;
    }

    .scoreboard-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.65);
      margin-top: 6px;
    }

    .scoreboard-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 1rem;
    }

    .scoreboard-list li.me {
      border-color: var(--gold);
      box-shadow: 0 0 0 1px rgba(255,215,0,0.4);
    }

    .score-name {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar-badge {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .badge {
      font-size: 1.1rem;
    }

    .scoreboard-list li div:last-child {
      font-weight: 600;
    }

    .game-ideas {
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .game-ideas ul {
      margin: 4px 0 0;
      padding-left: 18px;
    }

    /* BUZZ OVERLAY */
    .buzz-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(0,0,0,0.8), rgba(0,0,0,0.92));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      backdrop-filter: blur(6px);
    }

    .buzz-overlay-content {
      background: radial-gradient(circle at top, rgba(37, 70, 110, 0.95), rgba(6, 14, 30, 0.95));
      border-radius: 28px;
      padding: 24px 22px 22px;
      border: 2px solid rgba(255,255,255,0.18);
      box-shadow: 0 30px 70px rgba(0,0,0,0.75);
      text-align: center;
      max-width: 460px;
      width: 94%;
    }

    .buzz-overlay-content h2 {
      margin: 0 0 8px;
      font-size: 1.6rem;
      color: var(--gold);
    }

    .buzz-overlay-content p {
      margin: 4px 0 0;
      font-size: 1.05rem;
      color: #fefefe;
    }

    #buzz-manager-controls .btn {
      flex: 1 1 46%;
      min-width: 150px;
    }

    /* Manager answer area in overlay */
    #buzz-overlay-answer-wrap {
      margin-top: 14px;
      display: none;
      text-align: left;
    }

    /* WINNER OVERLAY */
    .winner-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(5, 4, 25, 0.92), rgba(4, 12, 20, 0.95));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      backdrop-filter: blur(10px);
    }

    .winner-overlay-content {
      background: linear-gradient(135deg, rgba(59, 8, 37, 0.96), rgba(10, 51, 32, 0.94));
      border-radius: 30px;
      padding: 30px 26px 28px;
      border: 2px solid rgba(255, 215, 0, 0.4);
      box-shadow: 0 30px 80px rgba(0,0,0,0.8);
      text-align: center;
      max-width: 520px;
      width: min(92%, 520px);
    }

    .winner-overlay h2 {
      margin: 0 0 10px;
      font-size: 1.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--gold);
    }

    .winner-overlay p {
      margin: 0 auto 18px;
      font-size: 1.1rem;
      color: var(--muted);
      max-width: 380px;
    }

    .winner-overlay strong {
      color: #fffbea;
    }

    .buzz-overlay-answer-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.85;
      color: #ffecb3;
      margin-bottom: 4px;
    }

    .buzz-overlay-answer {
      font-size: 1.15rem;
      line-height: 1.5;
      font-weight: 600;
      color: #fffbea;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.35);
    }

    /* MOBILE OPTIMIZATIONS */
    @media (max-width: 700px) {
      header h1 {
        font-size: 1.8rem;
      }

      header p {
        font-size: 0.92rem;
      }

      .login-card {
        margin-top: 20px;
        padding: 16px 14px 18px;
      }

      .card,
      .main-layout {
        padding: 14px 12px 16px;
      }

      .question-text {
        font-size: 1.1rem;
      }

      .timer {
        font-size: 1.05rem;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .btn + .btn {
        margin-left: 0;
      }

      .manager-buttons {
        flex-direction: column;
      }

      .buzz-overlay-content {
        padding: 18px 16px 16px;
      }

      .buzz-overlay-answer {
        font-size: 1.1rem;
      }
    }

    @media (max-width: 380px) {
      header h1 {
        font-size: 1.6rem;
      }
      .question-text {
        font-size: 1.02rem;
      }
    }
  </style>
</head>
<body>
<div class="overlay">
  <div class="snowfield" aria-hidden="true"></div>
  <div class="container">
    <header>
      <div class="snowflakes">‚ùÑÔ∏è üéÑ ‚ùÑÔ∏è</div>
      <h1>Christmas Trivia Buzzer</h1>
      <p>Open this page on your phone, join with a festive name, and race to buzz in first!</p>
    </header>

    <!-- Wizard Entry -->
    <div class="login-card entry-wizard" id="login-card">
      <div class="wizard-progress">
        <h2 id="wizard-step-label">Step 1 ¬∑ Choose your path</h2>
        <p id="wizard-step-subtitle">Are you hosting tonight or hopping into an existing room?</p>
      </div>

      <div class="wizard-step active" id="wizard-step-mode" data-step="mode">
        <div class="wizard-name-block">
          <label class="field-label" for="username-input">Festive Name</label>
          <input id="username-input" type="text" placeholder="e.g. Rudolph, Elf #1" autocomplete="off" />
          <p class="helper-text">Tip: Short names look best on the scoreboard.</p>
        </div>

        <div class="wizard-grid">
          <button class="wizard-card" id="wizard-host-card" type="button">
            <span class="wizard-pill">Host</span>
            <span class="wizard-card-title">üéâ Host a New Room</span>
            <span class="wizard-card-copy">Spin up a fresh festive lobby. We‚Äôll mint a cozy code and give you manager powers.</span>
          </button>
          <button class="wizard-card secondary" id="wizard-join-card" type="button">
            <span class="wizard-pill">Join</span>
            <span class="wizard-card-title">üéÅ Join an Existing Room</span>
            <span class="wizard-card-copy">Peek at the live lobby or paste the invite code you already received.</span>
          </button>
        </div>
      </div>

      <div class="wizard-step" id="wizard-step-host" data-step="host">
        <div class="wizard-back-row">
          <button class="wizard-back" type="button" data-go-step="mode">‚Üê Back</button>
          <span class="wizard-pill">Host view</span>
        </div>
        <p>We generated a magical room code for your crew. Share it and you‚Äôll become manager once you join.</p>
        <div class="code-display" id="wizard-code-display">----</div>
        <div class="helper-text">Need a different vibe? Tap create again for a fresh combo.</div>
        <div class="code-actions">
          <button class="btn btn-secondary" id="create-game-btn" type="button">‚ú® New Cozy Code</button>
          <button class="btn btn-primary" id="copy-invite-btn" type="button" disabled>üîó Copy Invite Link</button>
        </div>
        <div class="invite-chip" id="invite-chip">üîó Shareable link appears once you have a code.</div>
      </div>

      <div class="wizard-step" id="wizard-step-join" data-step="join">
        <div class="wizard-back-row">
          <button class="wizard-back" type="button" data-go-step="mode">‚Üê Back</button>
          <span class="wizard-pill">Guest view</span>
        </div>
        <label class="field-label" for="game-code-input">Game Code</label>
        <input id="game-code-input" type="text" placeholder="e.g. SNOW-123" autocomplete="off" />
        <p class="helper-text">Tap a lobby listing below or paste the code your host sent.</p>
        <div class="lobby-panel">
          <h3>üéØ Live Lobby</h3>
          <p>Peek at active rooms and tap one to fill the code automatically.</p>
          <ul class="lobby-list" id="lobby-list">
            <li class="lobby-item empty">No rooms yet. Be the first to start one!</li>
          </ul>
        </div>
      </div>

      <div class="wizard-cta" id="wizard-cta">
        <button class="btn btn-primary" id="join-btn">üéÑ Enter the Room</button>
        <button class="btn btn-secondary" id="reset-game-btn">üîÅ Reset Game (host)</button>
        <p id="login-error" style="color:#ffcccc; font-size:0.85rem; min-height:1em;"></p>
      </div>

      <p class="tagline">First player becomes the Game Manager üéÖ</p>
    </div>

    <!-- Main Game -->
    <div class="main-layout" id="main-layout" style="display:none;">
      <div id="role-banner"></div>
      <div class="grid">
        <!-- Question / Buzz -->
        <div class="card">
          <h2 class="card-title">
            <span>üéÅ Question Deck</span>
            <span class="question-progress" id="question-progress">‚Äî</span>
          </h2>
          <div class="question-meta">
            <span id="question-points">Waiting for kickoff‚Ä¶</span>
            <span id="question-difficulty" class="badge-chip">Warm-Up</span>
          </div>
          <div class="question-text" id="question-text">
            Waiting for the manager to start the first question...
          </div>
          <div class="timer" id="timer">--</div>
          <div class="status" id="status-line"></div>

          <div class="buzz-section">
            <button class="btn btn-secondary buzz-btn" id="buzz-btn" disabled>üõéÔ∏è Buzz In!</button>
          </div>

          <div id="toast"></div>

          <div class="manager-panel" id="manager-panel" style="display:none;">
            <h3>üéÖ Game Manager Controls</h3>
            <div class="manager-buttons">
              <button class="btn btn-primary" id="start-next-btn">‚ñ∂Ô∏è Start / Next Question</button>
              <button class="btn btn-secondary" id="skip-btn">‚è≠Ô∏è Skip</button>
              <button class="btn btn-secondary" id="end-game-btn">üèÅ End Game</button>
            </div>
            <div style="font-size:0.9rem; text-align:left;">
              <strong>Answer Key (also shown in manager popup):</strong>
              <div id="manager-answer-key" style="margin-top:4px; font-style:italic;"></div>
            </div>
          </div>

          <div class="leave-game-row">
            <button class="btn btn-secondary" id="leave-game-btn" type="button">üö™ Leave Game</button>
          </div>
        </div>

        <!-- Scoreboard -->
        <div class="card">
          <h2 class="card-title">
            <span>üéÑ Scoreboard</span>
            <span class="badge-chip" style="font-size:0.78rem;">Live Standings</span>
          </h2>
          <div class="scoreboard-header">
            <span>Players</span>
            <span>Points</span>
          </div>
          <ul class="scoreboard-list" id="scoreboard"></ul>
          <div class="game-ideas">
            <strong>Bonus fun:</strong>
            <ul>
              <li>üëë Leader wears the crown each round.</li>
              <li>üî• 2+ correct in a row = "On Fire" streak.</li>
              <li>üéÅ 5+ points earns a "Christmas Legend" award.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Buzz overlay (shown when someone buzzes in) -->
<div id="buzz-overlay" class="buzz-overlay">
  <div class="buzz-overlay-content">
    <h2 id="buzz-overlay-heading">üéÑ Buzz!</h2>
    <p id="buzz-overlay-text"></p>

    <!-- Manager-only answer + controls on the popup -->
    <div id="buzz-overlay-answer-wrap">
      <div class="buzz-overlay-answer-label">Correct Answer</div>
      <div id="buzz-overlay-answer" class="buzz-overlay-answer"></div>
    </div>

    <div id="buzz-manager-controls" style="margin-top:16px; display:none;">
      <p style="font-size:0.88rem; margin-bottom:8px;">Manager: mark this answer.</p>
      <div class="manager-buttons" style="justify-content:center;">
        <button class="btn btn-secondary" id="overlay-correct-btn">‚úÖ Correct</button>
        <button class="btn btn-secondary" id="overlay-incorrect-btn">‚ùå Incorrect</button>
        <button class="btn btn-secondary" id="overlay-skip-btn">‚è≠Ô∏è Skip</button>
        <button class="btn btn-primary" id="overlay-next-btn">‚ñ∂Ô∏è Next Question</button>
      </div>
    </div>
  </div>
</div>

<!-- Winner overlay (shown when game ends) -->
<div id="winner-overlay" class="winner-overlay">
  <div class="winner-overlay-content">
    <h2>üèÜ Snowfall Champion</h2>
    <p id="winner-overlay-message">A champion will appear soon‚Ä¶</p>
    <button class="btn btn-primary" id="winner-close-btn" type="button">üéâ Spread the Cheer</button>
  </div>
</div>

<!-- Firebase (modular SDK) + game logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    onValue,
    set,
    update,
    remove,
    onDisconnect,
    runTransaction,
    get
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
  import { firebaseConfig } from "./firebase-config.js";

  import { questions } from './questions.js';

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  let serverTimeOffset = 0;

  onValue(ref(db, ".info/serverTimeOffset"), (snap) => {
    serverTimeOffset = snap.val() || 0;
  });

  function getServerTime() {
    return Date.now() + serverTimeOffset;
  }

  let currentGameCode = null;
  let gameRef = null;
  let unsubscribeGame = null;

  // ---- DOM elements ----
  const loginCard = document.getElementById("login-card");
  const mainLayout = document.getElementById("main-layout");
  const usernameInput = document.getElementById("username-input");
  const gameCodeInput = document.getElementById("game-code-input");
  const joinBtn = document.getElementById("join-btn");
  const loginError = document.getElementById("login-error");
  const resetGameBtn = document.getElementById("reset-game-btn");
  const createGameBtn = document.getElementById("create-game-btn");
  const copyInviteBtn = document.getElementById("copy-invite-btn");
  const inviteChip = document.getElementById("invite-chip");
  const lobbyListEl = document.getElementById("lobby-list");
  const wizardStepLabel = document.getElementById("wizard-step-label");
  const wizardStepSubtitle = document.getElementById("wizard-step-subtitle");
  const wizardSteps = document.querySelectorAll(".wizard-step");
  const wizardCta = document.getElementById("wizard-cta");
  const wizardHostCard = document.getElementById("wizard-host-card");
  const wizardJoinCard = document.getElementById("wizard-join-card");
  const wizardBackButtons = document.querySelectorAll(".wizard-back");
  const wizardCodeDisplay = document.getElementById("wizard-code-display");
  const urlParams = new URLSearchParams(window.location.search);
  const urlGameParam = urlParams.get("game");
  const storedFestiveName = localStorage.getItem("festiveName") || "";

  const roleBanner = document.getElementById("role-banner");
  const questionTextEl = document.getElementById("question-text");
  const questionPointsEl = document.getElementById("question-points");
  const questionProgressEl = document.getElementById("question-progress");
  const questionDifficultyEl = document.getElementById("question-difficulty");
  const timerEl = document.getElementById("timer");
  const statusLineEl = document.getElementById("status-line");
  const buzzBtn = document.getElementById("buzz-btn");
  const scoreboardEl = document.getElementById("scoreboard");
  const toastEl = document.getElementById("toast");

  const managerPanel = document.getElementById("manager-panel");
  const startNextBtn = document.getElementById("start-next-btn");
  const skipBtn = document.getElementById("skip-btn");
  const endGameBtn = document.getElementById("end-game-btn");
  const leaveGameBtn = document.getElementById("leave-game-btn");
  const managerAnswerKey = document.getElementById("manager-answer-key");

  const buzzOverlay = document.getElementById("buzz-overlay");
  const buzzOverlayHeading = document.getElementById("buzz-overlay-heading");
  const buzzOverlayText = document.getElementById("buzz-overlay-text");
  const buzzOverlayAnswerWrap = document.getElementById("buzz-overlay-answer-wrap");
  const buzzOverlayAnswer = document.getElementById("buzz-overlay-answer");
  const buzzManagerControls = document.getElementById("buzz-manager-controls");
  const overlayCorrectBtn = document.getElementById("overlay-correct-btn");
  const overlayIncorrectBtn = document.getElementById("overlay-incorrect-btn");
  const overlaySkipBtn = document.getElementById("overlay-skip-btn");
  const overlayNextBtn = document.getElementById("overlay-next-btn");
  const winnerOverlay = document.getElementById("winner-overlay");
  const winnerOverlayMessage = document.getElementById("winner-overlay-message");
  const winnerCloseBtn = document.getElementById("winner-close-btn");

  // üéÑ Sound system with multiple files per action
  const soundGroups = {
    buzz: ['jingle-buzz-1.mp3', 'jingle-buzz-2.mp3'],
    correct: ['santa-correct-1.mp3', 'santa-correct-2.mp3', 'santa-correct-3.mp3', 'santa-correct-4.mp3'],
    incorrect: ['santa-sorry-1.mp3', 'santa-sorry-2.mp3', 'santa-sorry-3.mp3', 'santa-sorry-4.mp3'],
    next: ['chime-1.mp3', 'chime-2.mp3', 'chime-3.mp3', 'chime-4.mp3'],
    winner: ['chime-3.mp3', 'chime-4.mp3'],
    welcome: ['santa-welcome-1.mp3', 'santa-welcome-2.mp3', 'santa-welcome-3.mp3', 'santa-welcome-4.mp3']
  };
  const QUESTION_DURATION_MS = 120000; // 2 minutes

  // ---- Local state ----
  let myId = null;
  let myName = null;
  let isManager = false;
  const getDefaultGameState = () => ({
    players: {},
    managerId: null,
    questionIndex: -1,
    questionActive: false,
    currentResponderId: null,
    questionEndsAt: null,
    gameOver: false,
    winnerId: null,
    winnerName: null,
    winnerScore: 0,
    finalStandings: null
  });
  let gameState = getDefaultGameState();
  let timerInterval = null;
  let lastResponderId = null;
  let inviteCopyTimeout = null;
  let unsubscribeLobby = null;
  let wizardStepState = "mode";
  let wizardChoice = null;
  let lastGameOverState = false;
  let winnerOverlayDismissed = false;
  let hasRenderedGameState = false;
  const PLAYER_COOKIE_NAME = "ctg_session";
  const PLAYER_COOKIE_MAX_AGE_SECONDS = 6 * 60 * 60; // 6 hours

  const wizardMeta = {
    mode: {
      label: "Step 1 ¬∑ Choose your path",
      subtitle: "Are you hosting tonight or hopping into an existing room?",
      cta: false,
      joinLabel: "üéÑ Enter the Room",
      showReset: false
    },
    host: {
      label: "Step 2 ¬∑ Host setup",
      subtitle: "Share the generated code and tap Enter when you're ready to join.",
      cta: true,
      joinLabel: "üéÑ Enter My New Room",
      showReset: true
    },
    join: {
      label: "Step 2 ¬∑ Join a room",
      subtitle: "Pick a lobby listing or paste the code your host shared.",
      cta: true,
      joinLabel: "üéÆ Jump Into Game",
      showReset: false
    }
  };

  const festiveWords = [
    "HOLLY",
    "MERRY",
    "ELF",
    "SNOW",
    "STAR",
    "JOY",
    "NORTH",
    "LIGHT",
    "BELL",
    "SANTA"
  ];
  const MAX_LOBBY_ROOMS = 8;

  // ---- Helpers ----
  function genId() {
    return "p_" + Math.random().toString(36).slice(2);
  }

  function showToast(msg) {
    toastEl.textContent = msg || "";
    if (msg) {
      setTimeout(() => {
        if (toastEl.textContent === msg) toastEl.textContent = "";
      }, 4000);
    }
  }

  function formatGameCode(value = "") {
    const cleaned = value
      .trim()
      .toUpperCase()
      .replace(/[^A-Z0-9]/g, "");
    if (!cleaned) return "";
    if (cleaned.length <= 4) return cleaned;
    return `${cleaned.slice(0, 4)}-${cleaned.slice(4, 8)}`;
  }

  function generateFestiveCode() {
    const word = festiveWords[Math.floor(Math.random() * festiveWords.length)];
    const digits = Math.floor(100 + Math.random() * 900);
    return `${word}-${digits}`;
  }

  function ensureHostCode(forceNew = false) {
    if (!gameCodeInput) return "";
    let code = formatGameCode(gameCodeInput.value);
    if (!code || forceNew) {
      code = generateFestiveCode();
    }
    gameCodeInput.value = code;
    updateInviteState();
    return code;
  }

  function setWizardStep(step = "mode") {
    wizardStepState = step;
    wizardSteps.forEach((el) => {
      const target = el.dataset?.step;
      el.classList.toggle("active", target === step);
    });
    const meta = wizardMeta[step] || wizardMeta.mode;
    if (wizardStepLabel) wizardStepLabel.textContent = meta.label;
    if (wizardStepSubtitle) wizardStepSubtitle.textContent = meta.subtitle;
    if (wizardCta) wizardCta.style.display = meta.cta ? "flex" : "none";
    if (joinBtn) joinBtn.textContent = meta.joinLabel;
    if (resetGameBtn) resetGameBtn.style.display = meta.showReset ? "inline-flex" : "none";
    if (step === "host") ensureHostCode();
  }

  function persistPlayerSessionCookie({ playerId, playerName, gameCode }) {
    if (!playerId || !gameCode) return;
    const payload = {
      playerId,
      playerName: playerName || "",
      gameCode,
      expiresAt: Date.now() + PLAYER_COOKIE_MAX_AGE_SECONDS * 1000
    };
    const encoded = encodeURIComponent(JSON.stringify(payload));
    let cookie = `${PLAYER_COOKIE_NAME}=${encoded}; path=/; max-age=${PLAYER_COOKIE_MAX_AGE_SECONDS}; SameSite=Lax`;
    if (window.location.protocol === "https:") {
      cookie += "; Secure";
    }
    document.cookie = cookie;
  }

  function readPlayerSessionCookie() {
    const cookies = document.cookie ? document.cookie.split('; ') : [];
    const entry = cookies.find((row) => row.startsWith(`${PLAYER_COOKIE_NAME}=`));
    if (!entry) return null;
    try {
      const encoded = entry.split('=')[1];
      const payload = JSON.parse(decodeURIComponent(encoded));
      if (!payload?.playerId || !payload?.gameCode) {
        clearPlayerSessionCookie();
        return null;
      }
      if (payload.expiresAt && payload.expiresAt < Date.now()) {
        clearPlayerSessionCookie();
        return null;
      }
      return payload;
    } catch (err) {
      console.warn("Unable to parse player cookie", err);
      clearPlayerSessionCookie();
      return null;
    }
  }

  function clearPlayerSessionCookie() {
    document.cookie = `${PLAYER_COOKIE_NAME}=; path=/; max-age=0; SameSite=Lax`;
  }

  async function leaveGameAndReturnHome({ preserveName = true, toastMessage = "" } = {}) {
    const playerRef = myId ? roomRef(`players/${myId}`) : null;
    try {
      if (playerRef) {
        await remove(playerRef);
      }
    } catch (err) {
      console.warn("Unable to remove player while leaving", err);
    }

    clearPlayerSessionCookie();

    if (unsubscribeGame) {
      unsubscribeGame();
      unsubscribeGame = null;
    }

    gameRef = null;
    currentGameCode = null;
    gameState = getDefaultGameState();
    hasRenderedGameState = false;
    lastGameOverState = false;
    winnerOverlayDismissed = false;
    renderGame();
    hideBuzzOverlay();
    hideWinnerOverlay();

    if (mainLayout) mainLayout.style.display = "none";
    if (loginCard) loginCard.style.display = "block";
    wizardChoice = null;
    wizardStepState = "mode";
    setWizardStep("mode");

    if (gameCodeInput) {
      gameCodeInput.value = "";
      updateInviteState();
    }
    if (wizardCodeDisplay) {
      wizardCodeDisplay.textContent = "----";
    }

    if (usernameInput) {
      if (preserveName && myName) {
        usernameInput.value = myName;
      } else if (!preserveName) {
        usernameInput.value = "";
        myName = null;
        localStorage.removeItem("festiveName");
      }
    }

    const url = new URL(window.location.href);
    url.searchParams.delete("game");
    window.history.replaceState({}, "", url);

    myId = null;
    isManager = false;

    if (toastMessage) {
      showToast(toastMessage);
    }
  }

  function getRoomPath(subPath = "") {
    if (!currentGameCode) return null;
    const base = `games/${currentGameCode}`;
    return subPath ? `${base}/${subPath}` : base;
  }

  function roomRef(subPath = "") {
    const path = getRoomPath(subPath);
    if (!path) return null;
    return ref(db, path);
  }

  async function upsertPlayerRecord(playerId, playerName) {
    const playerRef = roomRef(`players/${playerId}`);
    if (!playerRef) return null;
    const now = getServerTime();
    await runTransaction(playerRef, (current) => {
      if (!current) {
        return {
          name: playerName || "Player",
          score: 0,
          streak: 0,
          connected: true,
          lastSeen: now
        };
      }
      current.name = playerName || current.name || "Player";
      if (current.score == null) current.score = 0;
      if (current.streak == null) current.streak = 0;
      current.connected = true;
      current.lastSeen = now;
      return current;
    });
    try {
      await onDisconnect(playerRef).update({ connected: false, lastSeen: getServerTime() });
    } catch (err) {
      console.warn("Unable to set disconnect handler", err);
    }
    return playerRef;
  }

  function subscribeToGame(code) {
    const normalized = formatGameCode(code);
    if (!normalized) return;
    if (normalized === currentGameCode && gameRef) return;
    if (unsubscribeGame) {
      unsubscribeGame();
      unsubscribeGame = null;
    }
    currentGameCode = normalized;
    gameRef = ref(db, `games/${normalized}`);
    if (gameCodeInput && gameCodeInput.value !== normalized) {
      gameCodeInput.value = normalized;
      updateInviteState();
    }
    gameState = getDefaultGameState();
    hasRenderedGameState = false;
    lastGameOverState = false;
    winnerOverlayDismissed = false;
    hideWinnerOverlay();
    renderGame();
    unsubscribeGame = onValue(gameRef, (snap) => {
      const val = snap.val() || getDefaultGameState();
      if (!val.players) val.players = {};
      gameState = val;
      renderGame();
    });
  }

  function ensureGameSelected(message = "Select or create a game first.") {
    if (!gameRef) {
      showToast(message);
      return false;
    }
    return true;
  }

  function updateInviteState() {
    if (!gameCodeInput || !copyInviteBtn || !inviteChip) return;
    const code = formatGameCode(gameCodeInput.value);
    if (gameCodeInput.value !== code) {
      gameCodeInput.value = code;
    }
    const hasCode = Boolean(code);
    copyInviteBtn.disabled = !hasCode;
    if (wizardCodeDisplay) {
      wizardCodeDisplay.textContent = hasCode ? code : "----";
    }

    if (!hasCode) {
      copyInviteBtn.textContent = "üîó Copy Invite Link";
      inviteChip.textContent = "üîó Shareable link appears once you have a code.";
      inviteChip.classList.remove("active");
      return;
    }

    const inviteUrl = `${window.location.origin}${window.location.pathname}?game=${encodeURIComponent(code)}`;
    inviteChip.textContent = inviteUrl;
    inviteChip.classList.add("active");
  }

  function timeAgo(timestamp) {
    if (!timestamp) return "Just now";
    const diff = getServerTime() - timestamp;
    if (diff < 60000) return "Just now";
    if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
    return `${Math.floor(diff / 86400000)}d ago`;
  }

  function renderLobbyList(gamesSnapshot) {
    if (!lobbyListEl) return;
    lobbyListEl.innerHTML = "";
    const entries = Object.entries(gamesSnapshot || {})
      .map(([code, data]) => ({
        code: formatGameCode(code) || code,
        updatedAt: data?.updatedAt || 0,
        players: Object.keys(data?.players || {}).length,
        questionActive: Boolean(data?.questionActive),
        questionIndex: data?.questionIndex ?? -1
      }))
      .filter((room) => room.players > 0 || room.updatedAt)
      .sort((a, b) => {
        if (b.updatedAt !== a.updatedAt) return b.updatedAt - a.updatedAt;
        return b.players - a.players;
      })
      .slice(0, MAX_LOBBY_ROOMS);

    if (!entries.length) {
      const empty = document.createElement("li");
      empty.className = "lobby-item empty";
      empty.textContent = "No rooms yet. Be the first to start one!";
      lobbyListEl.appendChild(empty);
      return;
    }

    entries.forEach((room) => {
      const li = document.createElement("li");
      li.className = "lobby-item";
      const left = document.createElement("div");
      const codeEl = document.createElement("div");
      codeEl.className = "lobby-code";
      codeEl.textContent = room.code;
      const metaEl = document.createElement("div");
      metaEl.className = "lobby-meta";
      metaEl.textContent = `${room.players} player${room.players === 1 ? "" : "s"} ‚Ä¢ Updated ${timeAgo(room.updatedAt)}`;
      left.appendChild(codeEl);
      left.appendChild(metaEl);

      const status = document.createElement("div");
      status.className = "lobby-status";
      status.textContent = room.questionActive ? "Live now" : "Idle";

      li.appendChild(left);
      li.appendChild(status);
      li.addEventListener("click", () => {
        if (gameCodeInput) {
          gameCodeInput.value = room.code;
          updateInviteState();
        }
        wizardChoice = "join";
        setWizardStep("join");
        subscribeToGame(room.code);
        showToast(`Room ${room.code} loaded. Enter your name to join.`);
      });
      lobbyListEl.appendChild(li);
    });
  }

  function initLobbyListener() {
    if (unsubscribeLobby) return;
    const rootRef = ref(db, "games");
    unsubscribeLobby = onValue(rootRef, (snap) => {
      renderLobbyList(snap.val());
    });
  }

  function handleAutoJoinFromUrl() {
    if (myId) return;
    if (!urlGameParam) return;
    const formatted = formatGameCode(urlGameParam);
    if (!formatted) return;
    if (gameCodeInput) {
      gameCodeInput.value = formatted;
      updateInviteState();
    }
    wizardChoice = "join";
    setWizardStep("join");
    subscribeToGame(formatted);
    if (storedFestiveName && usernameInput) {
      usernameInput.value = storedFestiveName;
      setTimeout(() => {
        if (!myId) joinBtn.click();
      }, 400);
    } else {
      showToast(`Invite ready for ${formatted}. Enter your name to join.`);
    }
  }

  async function attemptCookieRestore() {
    const session = readPlayerSessionCookie();
    if (!session) return;
    try {
      const formattedCode = formatGameCode(session.gameCode);
      if (!formattedCode) {
        clearPlayerSessionCookie();
        return;
      }

      const roomSnapshot = await get(ref(db, `games/${formattedCode}`));
      const roomData = roomSnapshot.exists() ? roomSnapshot.val() : null;
      const roomInactive = !roomData || roomData.gameOver;
      if (roomInactive) {
        clearPlayerSessionCookie();
        showToast("That game has ended. Create or join a new room.");
        return;
      }

      wizardChoice = "join";
      setWizardStep("join");
      if (gameCodeInput) {
        gameCodeInput.value = formattedCode;
        updateInviteState();
      }
      if (usernameInput && session.playerName) {
        usernameInput.value = session.playerName;
      }
      subscribeToGame(formattedCode);
      myId = session.playerId;
      myName = (session.playerName || "").substring(0, 20);
      if (myName) {
        localStorage.setItem("festiveName", myName);
      }
      await upsertPlayerRecord(myId, myName);
      persistPlayerSessionCookie({
        playerId: myId,
        playerName: myName,
        gameCode: formattedCode
      });
      if (loginCard) loginCard.style.display = "none";
      if (mainLayout) mainLayout.style.display = "block";
      showToast(`Welcome back! Rejoining ${formattedCode}.`);
    } catch (err) {
      console.error("Auto-restore failed", err);
      clearPlayerSessionCookie();
    }
  }

  if (gameCodeInput) {
    if (urlGameParam) {
      gameCodeInput.value = formatGameCode(urlGameParam);
    }
    updateInviteState();
    gameCodeInput.addEventListener("input", updateInviteState);
    gameCodeInput.addEventListener("keyup", (e) => {
      if (e.key === "Enter") joinBtn.click();
    });
  }

  if (storedFestiveName && usernameInput && !usernameInput.value) {
    usernameInput.value = storedFestiveName;
  }

  wizardHostCard?.addEventListener("click", () => {
    wizardChoice = "host";
    ensureHostCode();
    setWizardStep("host");
    showToast("Share your code then tap Enter when you're ready to manage.");
  });

  wizardJoinCard?.addEventListener("click", () => {
    wizardChoice = "join";
    setWizardStep("join");
  });

  wizardBackButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      wizardChoice = null;
      setWizardStep(btn.dataset?.goStep || "mode");
    });
  });

  setWizardStep("mode");

  createGameBtn?.addEventListener("click", () => {
    if (!gameCodeInput) return;
    ensureHostCode(true);
  });

  copyInviteBtn?.addEventListener("click", async () => {
    if (!gameCodeInput || !copyInviteBtn) return;
    const code = formatGameCode(gameCodeInput.value);
    if (!code) return;
    gameCodeInput.value = code;
    updateInviteState();
    const inviteUrl = `${window.location.origin}${window.location.pathname}?game=${encodeURIComponent(code)}`;
    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(inviteUrl);
      } else {
        throw new Error("Clipboard API unavailable");
      }
      copyInviteBtn.textContent = "‚úÖ Copied!";
    } catch (err) {
      copyInviteBtn.textContent = "üìã Link Ready";
      showToast(`Share this link: ${inviteUrl}`);
    }
    clearTimeout(inviteCopyTimeout);
    inviteCopyTimeout = setTimeout(() => {
      copyInviteBtn.textContent = "üîó Copy Invite Link";
    }, 2600);
  });

  function getCurrentQuestion() {
    if (gameState.questionIndex == null || gameState.questionIndex < 0) return null;
    return questions[gameState.questionIndex] || null;
  }

  function getDifficultyLabel(points) {
    if (points >= 3) return "Challenge";
    if (points === 2) return "Tricky";
    return "Warm-Up";
  }

  function playRandomSound(soundType) {
    if (!soundGroups[soundType]) return;

    const soundFiles = soundGroups[soundType];
    const randomIndex = Math.floor(Math.random() * soundFiles.length);
    const selectedSound = soundFiles[randomIndex];

    try {
      const audio = new Audio(`sounds/${selectedSound}`);
      audio.currentTime = 0;
      audio.play().catch(() => {});
    } catch (e) {}
  }

  function showBuzzOverlayUI(responderName) {
    buzzOverlayHeading.textContent = "üéÑ Buzz!";
    buzzOverlayText.textContent = `${responderName} buzzed in and is answering.`;

    if (isManager && gameState.currentResponderId) {
      buzzManagerControls.style.display = "block";

      const q = getCurrentQuestion();
      if (q && q.answer) {
        buzzOverlayAnswerWrap.style.display = "block";
        buzzOverlayAnswer.textContent = q.answer;
      } else {
        buzzOverlayAnswerWrap.style.display = "none";
        buzzOverlayAnswer.textContent = "";
      }
    } else {
      buzzManagerControls.style.display = "none";
      buzzOverlayAnswerWrap.style.display = "none";
      buzzOverlayAnswer.textContent = "";
    }

    buzzOverlay.style.display = "flex";
  }

  function getWinnerDetails() {
    if (!gameState.gameOver) return null;
    const standings = getFinalStandingsArray();
    if (standings && standings.length) {
      const top = standings[0];
      return {
        name: top?.name || gameState.winnerName || "A mystery elf",
        score: top?.score ?? gameState.winnerScore ?? 0
      };
    }
    if (gameState.winnerId && gameState.players && gameState.players[gameState.winnerId]) {
      const data = gameState.players[gameState.winnerId];
      return {
        name: data?.name || gameState.winnerName || "A mystery elf",
        score: data?.score ?? gameState.winnerScore ?? 0
      };
    }
    if (gameState.winnerName) {
      return {
        name: gameState.winnerName,
        score: gameState.winnerScore || 0
      };
    }
    return null;
  }

  function getFinalStandingsArray() {
    const standings = gameState.finalStandings;
    if (!standings) return null;
    if (Array.isArray(standings)) return standings;
    if (typeof standings === "object") return Object.values(standings);
    return null;
  }

  function showWinnerOverlayUI(details) {
    if (!winnerOverlay || !winnerOverlayMessage) return;
    const name = details?.name || "A champion";
    const score = details?.score ?? 0;
    winnerOverlayMessage.innerHTML = "";
    const nameStrong = document.createElement("strong");
    nameStrong.textContent = name;
    const midText = document.createTextNode(" wins the night with ");
    const scoreStrong = document.createElement("strong");
    scoreStrong.textContent = `${score} point${score === 1 ? "" : "s"}`;
    const endText = document.createTextNode("!");
    winnerOverlayMessage.append(nameStrong, midText, scoreStrong, endText);
    winnerOverlay.style.display = "flex";
  }

  function hideWinnerOverlay(manual = false) {
    if (!winnerOverlay) return;
    winnerOverlay.style.display = "none";
    if (manual) winnerOverlayDismissed = true;
  }

  function hideBuzzOverlay() {
    buzzOverlay.style.display = "none";
    buzzManagerControls.style.display = "none";
    buzzOverlayAnswerWrap.style.display = "none";
    buzzOverlayAnswer.textContent = "";
  }

  function updateTimer() {
    if (timerInterval) clearInterval(timerInterval);

    const hasRealResponder =
      gameState.questionActive &&
      gameState.currentResponderId &&
      gameState.players &&
      gameState.players[gameState.currentResponderId];

    if (hasRealResponder) {
      const p = gameState.players[gameState.currentResponderId];
      const name = p ? p.name : "A player";
      timerEl.textContent = `‚è∏Ô∏è Timer paused while ${name} answers`;
      return;
    }

    const popupActive =
      isManager &&
      gameState.questionActive &&
      buzzOverlay?.style.display === "flex" &&
      !hasRealResponder;
    if (popupActive) {
      timerEl.textContent = "‚è∏Ô∏è Timer paused while the popup is open";
      return;
    }

    if (!gameState.questionActive || !gameState.questionEndsAt) {
      timerEl.textContent = "--";
      return;
    }

    function tick() {
      const now = getServerTime();
      const diff = gameState.questionEndsAt - now;
      if (diff <= 0) {
        timerEl.textContent = "0s (time up)";
        buzzBtn.disabled = true;
        clearInterval(timerInterval);
        return;
      }
      const seconds = Math.ceil(diff / 1000);
      timerEl.textContent = seconds + "s remaining";
    }
    tick();
    timerInterval = setInterval(tick, 300);
  }

  function renderGame() {
    // Role
    isManager = gameState.managerId === myId;
    roleBanner.textContent = isManager
      ? "You are the Game Manager. Start questions and mark answers."
      : "You are a Player. Buzz in when you know it!";
    managerPanel.style.display = isManager ? "block" : "none";
    if (leaveGameBtn) {
      if (myId) {
        leaveGameBtn.style.display = "inline-flex";
        leaveGameBtn.disabled = false;
      } else {
        leaveGameBtn.style.display = "none";
      }
    }

    // Question
    const q = getCurrentQuestion();
    if (!q) {
      questionTextEl.textContent = "Waiting for the manager to start the first question...";
      questionPointsEl.textContent = "Ready when you are";
      questionProgressEl.textContent = "‚Äî";
      questionDifficultyEl.textContent = "Warm-Up";
      questionDifficultyEl.dataset.level = "warm-up";
      managerAnswerKey.textContent = "";
    } else {
      questionTextEl.textContent = q.text;
      questionPointsEl.textContent = `${q.points} pt${q.points > 1 ? "s" : ""} question`;
      const progress = `${Math.min(gameState.questionIndex + 1, questions.length)}/${questions.length}`;
      questionProgressEl.textContent = `Q${progress}`;
      const difficulty = getDifficultyLabel(q.points);
      questionDifficultyEl.textContent = difficulty;
      questionDifficultyEl.dataset.level = difficulty.toLowerCase();
      if (isManager) {
        managerAnswerKey.textContent = q.answer;
      } else {
        managerAnswerKey.textContent = "(manager only)";
      }
    }

    const hasRealResponder =
      gameState.questionActive &&
      gameState.currentResponderId &&
      gameState.players &&
      gameState.players[gameState.currentResponderId];

    // Buzz sound when new responder
    if (hasRealResponder && gameState.currentResponderId !== lastResponderId) {
      playRandomSound('buzz');
      lastResponderId = gameState.currentResponderId;
    }
    if (!hasRealResponder) {
      lastResponderId = null;
    }

    // Status / Buzz & overlay
    if (gameState.gameOver) {
      statusLineEl.textContent = "Game over! Congrats to the champion.";
      buzzBtn.disabled = true;
      hideBuzzOverlay();
    } else if (!gameState.questionActive) {
      statusLineEl.textContent = "No active question. Waiting for manager...";
      buzzBtn.disabled = true;
      hideBuzzOverlay();
    } else {
      if (!hasRealResponder) {
        statusLineEl.textContent = "Question is live! Tap Buzz when you know the answer.";
        buzzBtn.disabled = false;
        hideBuzzOverlay();
      } else if (gameState.currentResponderId === myId) {
        statusLineEl.textContent = "You have the floor. Answer out loud!";
        buzzBtn.disabled = true;
        const selfName = myName || "You";
        showBuzzOverlayUI(selfName);
      } else {
        const responder = gameState.players[gameState.currentResponderId];
        const name = responder ? responder.name : "Another player";
        statusLineEl.textContent = `${name} is answering...`;
        buzzBtn.disabled = true;
        showBuzzOverlayUI(name);
      }
    }

    // Scoreboard
    const livePlayers = Object.entries(gameState.players || {}).map(([id, p]) => ({
      id,
      ...(p || {})
    }));

    let scoreboardArray = livePlayers;
    const finalStandings = getFinalStandingsArray();
    if (gameState.gameOver && finalStandings && finalStandings.length) {
      scoreboardArray = finalStandings.map((entry) => ({
        id: entry.id,
        name: entry.name,
        score: entry.score,
        streak: entry.streak || 0
      }));
    }

    scoreboardArray.sort((a, b) => {
      if ((b.score || 0) !== (a.score || 0)) return (b.score || 0) - (a.score || 0);
      const nameA = (a.name || "").toString();
      const nameB = (b.name || "").toString();
      return nameA.localeCompare(nameB);
    });

    scoreboardEl.innerHTML = "";
    if (!scoreboardArray.length) {
      scoreboardEl.innerHTML = "<li>No players yet.</li>";
    } else {
      const leaderId = scoreboardArray[0].id;
      scoreboardArray.forEach(p => {
        const li = document.createElement("li");
        if (p.id === myId) li.classList.add("me");

        const left = document.createElement("div");
        left.className = "score-name";
        const avatar = document.createElement("span");
        avatar.className = "avatar-badge";
        avatar.textContent = (p.name || "?")
          .trim()
          .slice(0, 2)
          .toUpperCase();
        const nameSpan = document.createElement("span");
        const displayName = p.name || "Mystery Elf";
        nameSpan.textContent = displayName + (p.id === myId ? " (you)" : "");
        left.appendChild(avatar);
        left.appendChild(nameSpan);

        if (p.id === leaderId && p.score > 0) {
          const crown = document.createElement("span");
          crown.className = "badge";
          crown.textContent = "üëë";
          left.appendChild(crown);
        }
        if (p.streak >= 2) {
          const flame = document.createElement("span");
          flame.className = "badge";
          flame.textContent = "üî•";
          left.appendChild(flame);
        }
        if (p.score >= 5) {
          const gift = document.createElement("span");
          gift.className = "badge";
          gift.textContent = "üéÅ";
          left.appendChild(gift);
        }

        const right = document.createElement("div");
        right.textContent = `${p.score || 0} pts`;

        li.appendChild(left);
        li.appendChild(right);
        scoreboardEl.appendChild(li);
      });
    }

    const isGameOver = Boolean(gameState.gameOver);
    if (isGameOver) {
      const winnerDetails = getWinnerDetails();
      if (!winnerOverlayDismissed && winnerDetails) {
        showWinnerOverlayUI(winnerDetails);
      }
    } else {
      winnerOverlayDismissed = false;
      hideWinnerOverlay();
    }

    if (isGameOver && !lastGameOverState && hasRenderedGameState) {
      playRandomSound('winner');
    }

    lastGameOverState = isGameOver;
    hasRenderedGameState = true;

    updateTimer();
  }

  // ---- Join game ----
  joinBtn.addEventListener("click", async () => {
    if (myId) {
      showToast("You're already in this game.");
      return;
    }
    const name = usernameInput.value.trim();
    if (!name) {
      loginError.textContent = "Enter a festive name.";
      return;
    }
    const codeInputValue = gameCodeInput ? gameCodeInput.value : "";
    const selectedCode = formatGameCode(codeInputValue);
    if (!selectedCode) {
      loginError.textContent = "Enter or create a game code.";
      return;
    }
    loginError.textContent = "";
    myId = genId();
    myName = name.substring(0, 20);
    localStorage.setItem("festiveName", myName);
    subscribeToGame(selectedCode);
    const url = new URL(window.location.href);
    url.searchParams.set("game", selectedCode);
    window.history.replaceState({}, "", url);
    updateInviteState();

    const playerRef = await upsertPlayerRecord(myId, myName);
    if (!playerRef) {
      loginError.textContent = "Could not find that game room. Try again.";
      return;
    }
    const roomBaseRef = roomRef();
    if (roomBaseRef) {
      await update(roomBaseRef, { updatedAt: getServerTime() });
    }

    const managerRef = roomRef("managerId");
    const managerResult = await runTransaction(managerRef, (current) => current || myId);
    const becameManager = managerResult?.committed && managerResult.snapshot?.val() === myId;
    if (becameManager) {
      playRandomSound('welcome');
    }

    persistPlayerSessionCookie({
      playerId: myId,
      playerName: myName,
      gameCode: selectedCode
    });

    loginCard.style.display = "none";
    mainLayout.style.display = "block";
  });

  usernameInput.addEventListener("keyup", (e) => {
    if (e.key === "Enter") joinBtn.click();
  });

  // ---- Reset game ----
  resetGameBtn.addEventListener("click", async () => {
    const sure = confirm("Reset the game for everyone? This clears players and questions.");
    if (!sure) return;
    const codeSource = formatGameCode((gameCodeInput?.value || currentGameCode || "") );
    if (!codeSource) {
      showToast("Enter a game code to reset.");
      return;
    }

    try {
      const resetRef = ref(db, `games/${codeSource}`);
      await remove(resetRef);
      if (codeSource === currentGameCode) {
        gameState = getDefaultGameState();
        renderGame();
      }
      showToast(`üéÑ Game ${codeSource} reset. First player to join becomes the new manager.`);
    } catch (err) {
      console.error("Error resetting game", err);
      showToast("Could not reset game. Check console for details.");
    }
  });

  // ---- Manager action helpers ----
  async function handleStartNext() {
    if (!isManager || !ensureGameSelected()) return;
    await runTransaction(gameRef, (current) => {
      const now = getServerTime();

      if (!current) {
        current = {
          players: {},
          managerId: myId,
          questionIndex: 0,
          questionActive: true,
          currentResponderId: null,
          questionEndsAt: now + QUESTION_DURATION_MS,
          updatedAt: now,
          gameOver: false,
          winnerId: null,
          winnerName: null,
          winnerScore: 0,
          finalStandings: null
        };
        return current;
      }

      if (current.questionIndex == null || current.questionIndex < 0) {
        current.questionIndex = 0;
        current.questionActive = true;
        current.currentResponderId = null;
        current.questionEndsAt = now + QUESTION_DURATION_MS;
        current.updatedAt = now;
        current.gameOver = false;
        current.winnerId = null;
        current.winnerName = null;
        current.winnerScore = 0;
        current.finalStandings = null;
        return current;
      }

      if (current.questionIndex < questions.length - 1) {
        current.questionIndex += 1;
        current.questionActive = true;
        current.currentResponderId = null;
        current.questionEndsAt = now + QUESTION_DURATION_MS;
        current.updatedAt = now;
        current.gameOver = false;
        current.winnerId = null;
        current.winnerName = null;
        current.winnerScore = 0;
        current.finalStandings = null;
        return current;
      }

      current.questionActive = false;
      current.currentResponderId = null;
      current.questionEndsAt = null;
      current.updatedAt = now;
      return current;
    });
    hideBuzzOverlay();
    playRandomSound('next');
  }

  async function handleCorrect() {
    if (!isManager || !ensureGameSelected()) return;
    const now = getServerTime();
    await runTransaction(gameRef, (current) => {
      if (!current || !current.currentResponderId) return current;
      const responderId = current.currentResponderId;
      const qIndex = current.questionIndex ?? 0;
      const q = questions[qIndex] || { points: 1 };
      current.players = current.players || {};
      const p = current.players[responderId];
      if (p) {
        p.score = (p.score || 0) + (q.points || 1);
        p.streak = (p.streak || 0) + 1;
      }
      current.questionActive = false;
      current.currentResponderId = null;
      current.questionEndsAt = null;
      current.updatedAt = now;
      current.gameOver = false;
      current.winnerId = null;
      current.winnerName = null;
      current.winnerScore = 0;
      current.finalStandings = null;
      return current;
    });
    hideBuzzOverlay();
    playRandomSound('correct');
  }

  async function handleIncorrect() {
    if (!isManager || !ensureGameSelected()) return;
    const now = getServerTime();
    await runTransaction(gameRef, (current) => {
      if (!current || !current.currentResponderId) return current;
      const responderId = current.currentResponderId;
      current.players = current.players || {};
      const p = current.players[responderId];
      if (p) p.streak = 0;
      current.currentResponderId = null;
      current.updatedAt = now;
      current.gameOver = false;
      current.winnerId = null;
      current.winnerName = null;
      current.winnerScore = 0;
      current.finalStandings = null;
      return current;
    });
    hideBuzzOverlay();
    playRandomSound('incorrect');
  }

  async function handleSkip() {
    if (!isManager || !ensureGameSelected()) return;
    const now = getServerTime();
    await runTransaction(gameRef, (current) => {
      if (!current) return current;
      current.questionActive = false;
      current.currentResponderId = null;
      current.questionEndsAt = null;
      current.updatedAt = now;
      current.gameOver = false;
      current.winnerId = null;
      current.winnerName = null;
      current.winnerScore = 0;
      current.finalStandings = null;
      return current;
    });
    hideBuzzOverlay();
    playRandomSound('next');
  }

  async function handleEndGame() {
    if (!isManager || !ensureGameSelected()) return;
    const now = getServerTime();
    await runTransaction(gameRef, (current) => {
      if (!current) return current;
      current.players = current.players || {};
      const playerEntries = Object.entries(current.players).map(([id, data]) => ({
        id,
        name: data?.name || "Player",
        score: data?.score || 0,
        streak: data?.streak || 0
      }));
      playerEntries.sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        return a.name.localeCompare(b.name);
      });
      const winner = playerEntries[0];
      current.gameOver = true;
      current.winnerId = winner ? winner.id : null;
      current.winnerName = winner ? winner.name : null;
      current.winnerScore = winner ? winner.score : 0;
      current.finalStandings = playerEntries;
      current.questionActive = false;
      current.currentResponderId = null;
      current.questionEndsAt = null;
      current.updatedAt = now;
      return current;
    });
    hideBuzzOverlay();
    winnerOverlayDismissed = false;
    playRandomSound('winner');
    await leaveGameAndReturnHome({
      preserveName: true,
      toastMessage: "Game wrapped! You're back in the lobby."
    });
  }

  // ---- Buzz ----
  buzzBtn.addEventListener("click", async () => {
    if (!myId) return;
    if (!ensureGameSelected("Join a game before buzzing.")) return;
    buzzBtn.disabled = true;

    await runTransaction(gameRef, (current) => {
      if (!current || !current.questionActive) return current;
      if (current.currentResponderId) return current;
      current.currentResponderId = myId;
      return current;
    });
  });

  // ---- Manager actions: base buttons ----
  startNextBtn.addEventListener("click", handleStartNext);
  skipBtn.addEventListener("click", handleSkip);
  endGameBtn?.addEventListener("click", handleEndGame);

  // ---- Manager actions: overlay buttons ----
  overlayNextBtn.addEventListener("click", handleStartNext);
  overlayCorrectBtn.addEventListener("click", handleCorrect);
  overlayIncorrectBtn.addEventListener("click", handleIncorrect);
  overlaySkipBtn.addEventListener("click", handleSkip);
  winnerCloseBtn?.addEventListener("click", () => hideWinnerOverlay(true));
  leaveGameBtn?.addEventListener("click", () => {
    leaveGameAndReturnHome({ preserveName: true, toastMessage: "You left the game." });
  });

  attemptCookieRestore();
  initLobbyListener();
  handleAutoJoinFromUrl();
</script>
</body>
</html>
