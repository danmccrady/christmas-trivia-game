<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Christmas Trivia Buzzer (Online)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --red: #e63946;
      --red-dark: #b22222;
      --green: #0b6623;
      --green-soft: #17803b;
      --gold: #ffd700;
      --bg: #020b0f;
      --bg-soft: #071c1a;
      --card-bg: rgba(7, 28, 26, 0.95);
      --card-border: rgba(255, 255, 255, 0.15);
      --text: #fdfdfd;
      --muted: #cfd8dc;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      color: var(--text);
      background: radial-gradient(circle at top, #123, var(--bg));
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .overlay {
      min-height: 100vh;
      width: 100%;
      background:
        radial-gradient(circle at top, rgba(255,255,255,0.05), transparent 60%),
        linear-gradient(135deg, rgba(1, 10, 8, 0.98), rgba(0, 40, 24, 0.96));
      padding: 16px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* HEADER */
    header {
      text-align: center;
      margin-bottom: 18px;
    }

    header h1 {
      margin: 4px 0 2px;
      font-size: 2.2rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #fffbea;
      text-shadow: 0 0 16px rgba(255, 215, 0, 0.8);
    }

    header p {
      margin: 4px auto 0;
      font-size: 0.95rem;
      color: var(--muted);
      max-width: 420px;
    }

    .snowflakes {
      font-size: 1.5rem;
      animation: float-snow 4s ease-in-out infinite;
    }

    @keyframes float-snow {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    /* CARDS / PANELS */
    .card,
    .login-card,
    .main-layout {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      padding: 16px 16px 18px;
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(16px);
    }

    .login-card {
      max-width: 420px;
      margin: 32px auto 0;
      text-align: center;
    }

    .login-card p {
      margin: 0 0 10px;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .login-card input {
      width: 100%;
      padding: 11px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.35);
      color: var(--text);
      margin-bottom: 10px;
      font-size: 0.95rem;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .login-card input::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .login-card input:focus {
      border-color: var(--gold);
      background: rgba(0,0,0,0.55);
      box-shadow: 0 0 0 1px rgba(255,215,0,0.5);
    }

    .tagline {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.8);
      margin-top: 4px;
    }

    /* BUTTONS */
    .btn {
      padding: 11px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      transition:
        transform 0.08s ease,
        box-shadow 0.12s ease,
        background 0.15s ease,
        opacity 0.15s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--red), #ff6b6b);
      color: #fff;
      box-shadow: 0 8px 18px rgba(0,0,0,0.6);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--green), var(--green-soft));
      color: #fff;
      box-shadow: 0 6px 14px rgba(0,0,0,0.5);
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn:active:not(:disabled) {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }

    .btn + .btn {
      margin-left: 6px;
    }

    .main-layout {
      display: none;
      margin-top: 16px;
    }

    /* GRID LAYOUT */
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.35fr);
      gap: 16px;
      align-items: stretch;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* QUESTION CARD */
    .card h2 {
      margin: 0 0 8px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .question-text {
      font-size: 1.15rem;
      margin: 8px 0 12px;
      line-height: 1.4;
    }

    .timer {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 4px;
    }

    .status {
      font-size: 0.9rem;
      margin-top: 4px;
      color: #e0f2f1;
      min-height: 1.2em;
    }

    .buzz-section {
      margin-top: 18px;
      text-align: center;
    }

    .buzz-btn {
      font-size: 1.1rem;
      padding: 13px 26px;
      width: 100%;
      max-width: 320px;
      border-radius: 999px;
    }

    #toast {
      margin-top: 10px;
      font-size: 0.88rem;
      color: #ffe082;
      min-height: 1.1em;
      text-align: center;
    }

    .manager-panel {
      margin-top: 14px;
      border-top: 1px dashed rgba(255,255,255,0.18);
      padding-top: 10px;
      font-size: 0.9rem;
    }

    .manager-panel h3 {
      margin: 0 0 6px;
      font-size: 0.95rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      opacity: 0.9;
    }

    .manager-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    /* SCOREBOARD */
    .card h2 span {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    #role-banner {
      text-align: center;
      margin-bottom: 10px;
      font-size: 0.9rem;
      padding: 7px 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.12);
    }

    #role-banner::before {
      content: 'üéÑ ';
    }

    .scoreboard-list {
      list-style: none;
      padding: 0;
      margin: 8px 0 0;
      max-height: 280px;
      overflow-y: auto;
    }

    .scoreboard-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 10px;
      margin-bottom: 5px;
      border-radius: 999px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      font-size: 0.9rem;
    }

    .scoreboard-list li.me {
      border-color: var(--gold);
      box-shadow: 0 0 0 1px rgba(255,215,0,0.4);
    }

    .score-name {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge {
      font-size: 0.95rem;
    }

    .scoreboard-list li div:last-child {
      font-weight: 600;
    }

    .game-ideas {
      margin-top: 10px;
      font-size: 0.82rem;
      color: var(--muted);
    }

    .game-ideas ul {
      margin: 4px 0 0;
      padding-left: 18px;
    }

    /* BUZZ OVERLAY */
    .buzz-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(0,0,0,0.85), rgba(0,0,0,0.9));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .buzz-overlay-content {
      background: radial-gradient(circle at top, #1b3a1b, #020b08);
      border-radius: 22px;
      padding: 22px 20px 20px;
      border: 2px solid var(--gold);
      box-shadow: 0 0 60px rgba(0,0,0,0.9);
      text-align: center;
      max-width: 420px;
      width: 90%;
    }

    .buzz-overlay-content h2 {
      margin: 0 0 6px;
      font-size: 1.5rem;
      color: var(--gold);
    }

    .buzz-overlay-content p {
      margin: 4px 0 0;
      font-size: 0.98rem;
      color: #fefefe;
    }

    /* MOBILE OPTIMIZATIONS */
    @media (max-width: 700px) {
      header h1 {
        font-size: 1.7rem;
      }

      header p {
        font-size: 0.9rem;
      }

      .login-card {
        margin-top: 20px;
        padding: 16px 14px 18px;
      }

      .card,
      .main-layout {
        padding: 14px 12px 16px;
      }

      .question-text {
        font-size: 1.05rem;
      }

      .timer {
        font-size: 1rem;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .btn + .btn {
        margin-left: 0;
      }

      .manager-buttons {
        flex-direction: column;
      }

      .buzz-overlay-content {
        padding: 18px 16px 16px;
      }
    }

    /* EXTRA SMALL DEVICES */
    @media (max-width: 380px) {
      header h1 {
        font-size: 1.55rem;
      }
      .question-text {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
<div class="overlay">
  <div class="container">
    <header>
      <div class="snowflakes">‚ùÑÔ∏è üéÑ ‚ùÑÔ∏è</div>
      <h1>Christmas Trivia Buzzer</h1>
      <p>Open this page on your phone, join with a festive name, and race to buzz in first!</p>
    </header>

    <!-- Login -->
    <div class="login-card" id="login-card">
      <p>Enter your festive name to join the game.</p>
      <input id="username-input" type="text" placeholder="e.g. Rudolph, Elf #1" />
      <button class="btn btn-primary" id="join-btn">üéÆ Join the Game</button>
      <p class="tagline">First player becomes the Game Manager üéÖ</p>

      <!-- Reset Game button -->
      <button class="btn btn-secondary" id="reset-game-btn" style="margin-top:8px;">
        üîÅ Reset Game (host)
      </button>

      <p id="login-error" style="color:#ffcccc; font-size:0.85rem; min-height:1em;"></p>
    </div>

    <!-- Main Game -->
    <div class="main-layout" id="main-layout">
      <div id="role-banner"></div>
      <div class="grid">
        <!-- Question / Buzz -->
        <div class="card">
          <h2>
            üéÅ Current Question
            <span id="question-points"></span>
          </h2>
          <div class="question-text" id="question-text">
            Waiting for the manager to start the first question...
          </div>
          <div class="timer" id="timer">--</div>
          <div class="status" id="status-line"></div>

          <div class="buzz-section">
            <button class="btn btn-secondary buzz-btn" id="buzz-btn" disabled>üõéÔ∏è Buzz In!</button>
          </div>

          <div id="toast"></div>

          <div class="manager-panel" id="manager-panel" style="display:none;">
            <h3>üéÖ Game Manager Controls</h3>
            <div class="manager-buttons">
              <button class="btn btn-primary" id="start-next-btn">‚ñ∂Ô∏è Start / Next Question</button>
              <button class="btn btn-secondary" id="correct-btn">‚úÖ Correct</button>
              <button class="btn btn-secondary" id="incorrect-btn">‚ùå Incorrect</button>
              <button class="btn btn-secondary" id="skip-btn">‚è≠Ô∏è Skip</button>
            </div>
            <div style="font-size:0.85rem; text-align:left;">
              <strong>Answer Key:</strong>
              <div id="manager-answer-key" style="margin-top:4px; font-style:italic;"></div>
            </div>
          </div>
        </div>

        <!-- Scoreboard -->
        <div class="card">
          <h2>üéÑ Scoreboard</h2>
          <ul class="scoreboard-list" id="scoreboard"></ul>
          <div class="game-ideas">
            <strong>Bonus fun:</strong>
            <ul>
              <li>üëë Leader wears the crown each round.</li>
              <li>üî• 2+ correct in a row = "On Fire" streak.</li>
              <li>üéÅ 5+ points earns a "Christmas Legend" award.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Buzz overlay (shown when someone buzzes in) -->
<div id="buzz-overlay" class="buzz-overlay">
  <div class="buzz-overlay-content">
    <h2 id="buzz-overlay-heading">üéÑ Buzz!</h2>
    <p id="buzz-overlay-text"></p>

    <!-- Manager-only controls on the popup -->
    <div id="buzz-manager-controls" style="margin-top:16px; display:none;">
      <p style="font-size:0.85rem; margin-bottom:8px;">Manager: mark this answer.</p>
      <div class="manager-buttons" style="justify-content:center;">
        <button class="btn btn-secondary" id="overlay-correct-btn">‚úÖ Correct</button>
        <button class="btn btn-secondary" id="overlay-incorrect-btn">‚ùå Incorrect</button>
        <button class="btn btn-secondary" id="overlay-skip-btn">‚è≠Ô∏è Skip</button>
        <button class="btn btn-primary" id="overlay-next-btn">‚ñ∂Ô∏è Next Question</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase (modular SDK) + game logic -->
<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyBLzGCQZ5MlMlUbC8R7nSyft5TZt7ne8vw",
    authDomain: "christmas-trivia-game.firebaseapp.com",
    databaseURL: "https://christmas-trivia-game-default-rtdb.firebaseio.com",
    projectId: "christmas-trivia-game",
    storageBucket: "christmas-trivia-game.firebasestorage.app",
    messagingSenderId: "303000729988",
    appId: "1:303000729988:web:0f4c267de48a2a4d5e85d1",
    measurementId: "G-W2X9RER9C8"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    onValue,
    set,
    remove,
    onDisconnect,
    runTransaction
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  import { questions } from './questions.js';

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const gameRef = ref(db, "christmasTriviaGame");

  // ---- DOM elements ----
  const loginCard = document.getElementById("login-card");
  const mainLayout = document.getElementById("main-layout");
  const usernameInput = document.getElementById("username-input");
  const joinBtn = document.getElementById("join-btn");
  const loginError = document.getElementById("login-error");
  const resetGameBtn = document.getElementById("reset-game-btn");

  const roleBanner = document.getElementById("role-banner");
  const questionTextEl = document.getElementById("question-text");
  const questionPointsEl = document.getElementById("question-points");
  const timerEl = document.getElementById("timer");
  const statusLineEl = document.getElementById("status-line");
  const buzzBtn = document.getElementById("buzz-btn");
  const scoreboardEl = document.getElementById("scoreboard");
  const toastEl = document.getElementById("toast");

  const managerPanel = document.getElementById("manager-panel");
  const startNextBtn = document.getElementById("start-next-btn");
  const correctBtn = document.getElementById("correct-btn");
  const incorrectBtn = document.getElementById("incorrect-btn");
  const skipBtn = document.getElementById("skip-btn");
  const managerAnswerKey = document.getElementById("manager-answer-key");

  const buzzOverlay = document.getElementById("buzz-overlay");
  const buzzOverlayHeading = document.getElementById("buzz-overlay-heading");
  const buzzOverlayText = document.getElementById("buzz-overlay-text");
  const buzzManagerControls = document.getElementById("buzz-manager-controls");
  const overlayCorrectBtn = document.getElementById("overlay-correct-btn");
  const overlayIncorrectBtn = document.getElementById("overlay-incorrect-btn");
  const overlaySkipBtn = document.getElementById("overlay-skip-btn");
  const overlayNextBtn = document.getElementById("overlay-next-btn");

  // üéÑ Sound system with multiple files per action
  const soundGroups = {
    buzz: ['jingle-buzz-1.mp3', 'jingle-buzz-2.mp3'],
    correct: ['santa-correct-1.mp3', 'santa-correct-2.mp3', 'santa-correct-3.mp3', 'santa-correct-4.mp3'],
    incorrect: ['santa-sorry-1.mp3', 'santa-sorry-2.mp3', 'santa-sorry-3.mp3', 'santa-sorry-4.mp3'],
    next: ['chime-1.mp3', 'chime-2.mp3', 'chime-3.mp3', 'chime-4.mp3']
  };

  // ---- Local state ----
  let myId = null;
  let myName = null;
  let isManager = false;
  let gameState = {
    players: {},
    managerId: null,
    questionIndex: -1,
    questionActive: false,
    currentResponderId: null,
    questionEndsAt: null
  };
  let timerInterval = null;
  let lastResponderId = null;

  // ---- Helpers ----
  function genId() {
    return "p_" + Math.random().toString(36).slice(2);
  }

  function showToast(msg) {
    toastEl.textContent = msg || "";
    if (msg) {
      setTimeout(() => {
        if (toastEl.textContent === msg) toastEl.textContent = "";
      }, 4000);
    }
  }

  function getCurrentQuestion() {
    if (gameState.questionIndex == null || gameState.questionIndex < 0) return null;
    return questions[gameState.questionIndex] || null;
  }

  function playRandomSound(soundType) {
    if (!soundGroups[soundType]) return;

    const soundFiles = soundGroups[soundType];
    const randomIndex = Math.floor(Math.random() * soundFiles.length);
    const selectedSound = soundFiles[randomIndex];

    try {
      const audio = new Audio(`sounds/${selectedSound}`);
      audio.currentTime = 0;
      audio.play().catch(() => {});
    } catch (e) {}
  }

  function showBuzzOverlay(responderName) {
    buzzOverlayHeading.textContent = "üéÑ Buzz!";
    buzzOverlayText.textContent = `${responderName} buzzed in and is answering.`;
    if (isManager && gameState.currentResponderId) {
      buzzManagerControls.style.display = "block";
    } else {
      buzzManagerControls.style.display = "none";
    }
    buzzOverlay.style.display = "flex";
  }

  function hideBuzzOverlay() {
    buzzOverlay.style.display = "none";
    buzzManagerControls.style.display = "none";
  }

  function updateTimer() {
    if (timerInterval) clearInterval(timerInterval);

    const hasRealResponder =
      gameState.questionActive &&
      gameState.currentResponderId &&
      gameState.players &&
      gameState.players[gameState.currentResponderId];

    if (hasRealResponder) {
      const p = gameState.players[gameState.currentResponderId];
      const name = p ? p.name : "A player";
      timerEl.textContent = `‚è∏Ô∏è Timer paused while ${name} answers`;
      return;
    }

    if (!gameState.questionActive || !gameState.questionEndsAt) {
      timerEl.textContent = "--";
      return;
    }

    function tick() {
      const now = Date.now();
      const diff = gameState.questionEndsAt - now;
      if (diff <= 0) {
        timerEl.textContent = "0s (time up)";
        buzzBtn.disabled = true;
        clearInterval(timerInterval);
        return;
      }
      const seconds = Math.ceil(diff / 1000);
      timerEl.textContent = seconds + "s remaining";
    }
    tick();
    timerInterval = setInterval(tick, 300);
  }

  function renderGame() {
    // Role
    isManager = gameState.managerId === myId;
    roleBanner.textContent = isManager
      ? "You are the Game Manager. Start questions and mark answers."
      : "You are a Player. Buzz in when you know it!";
    managerPanel.style.display = isManager ? "block" : "none";

    // Question
    const q = getCurrentQuestion();
    if (!q) {
      questionTextEl.textContent = "Waiting for the manager to start the first question...";
      questionPointsEl.textContent = "";
      managerAnswerKey.textContent = "";
    } else {
      questionTextEl.textContent = q.text;
      questionPointsEl.textContent = `(${q.points} pt${q.points > 1 ? "s" : ""})`;
      if (isManager) {
        managerAnswerKey.textContent = q.answer;
      } else {
        managerAnswerKey.textContent = "(manager only)";
      }
    }

    const hasRealResponder =
      gameState.questionActive &&
      gameState.currentResponderId &&
      gameState.players &&
      gameState.players[gameState.currentResponderId];

    // Buzz sound when new responder
    if (hasRealResponder && gameState.currentResponderId !== lastResponderId) {
      playRandomSound('buzz');
      lastResponderId = gameState.currentResponderId;
    }
    if (!hasRealResponder) {
      lastResponderId = null;
    }

    // Status / Buzz & overlay
    if (!gameState.questionActive) {
      statusLineEl.textContent = "No active question. Waiting for manager...";
      buzzBtn.disabled = true;
      hideBuzzOverlay();
    } else {
      if (!hasRealResponder) {
        statusLineEl.textContent = "Question is live! Tap Buzz when you know the answer.";
        buzzBtn.disabled = false;
        hideBuzzOverlay();
      } else if (gameState.currentResponderId === myId) {
        statusLineEl.textContent = "You have the floor. Answer out loud!";
        buzzBtn.disabled = true;
        const selfName = myName || "You";
        showBuzzOverlay(selfName);
      } else {
        const responder = gameState.players[gameState.currentResponderId];
        const name = responder ? responder.name : "Another player";
        statusLineEl.textContent = `${name} is answering...`;
        buzzBtn.disabled = true;
        showBuzzOverlay(name);
      }
    }

    // Scoreboard
    const playersArray = Object.entries(gameState.players || {}).map(([id, p]) => ({
      id,
      ...p
    }));
    playersArray.sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      return a.name.localeCompare(b.name);
    });

    scoreboardEl.innerHTML = "";
    if (!playersArray.length) {
      scoreboardEl.innerHTML = "<li>No players yet.</li>";
    } else {
      const leaderId = playersArray[0].id;
      playersArray.forEach(p => {
        const li = document.createElement("li");
        if (p.id === myId) li.classList.add("me");

        const left = document.createElement("div");
        left.className = "score-name";
        const nameSpan = document.createElement("span");
        nameSpan.textContent = p.name + (p.id === myId ? " (you)" : "");
        left.appendChild(nameSpan);

        if (p.id === leaderId && p.score > 0) {
          const crown = document.createElement("span");
          crown.className = "badge";
          crown.textContent = "üëë";
          left.appendChild(crown);
        }
        if (p.streak >= 2) {
          const flame = document.createElement("span");
          flame.className = "badge";
          flame.textContent = "üî•";
          left.appendChild(flame);
        }
        if (p.score >= 5) {
          const gift = document.createElement("span");
          gift.className = "badge";
          gift.textContent = "üéÅ";
          left.appendChild(gift);
        }

        const right = document.createElement("div");
        right.textContent = `${p.score} pts`;

        li.appendChild(left);
        li.appendChild(right);
        scoreboardEl.appendChild(li);
      });
    }

    updateTimer();
  }

  // ---- Firebase listeners ----
  onValue(gameRef, (snap) => {
    const val = snap.val();
    gameState = val || {
      players: {},
      managerId: null,
      questionIndex: -1,
      questionActive: false,
      currentResponderId: null,
      questionEndsAt: null
    };
    if (!gameState.players) gameState.players = {};
    renderGame();
  });

  // ---- Join game ----
  joinBtn.addEventListener("click", async () => {
    const name = usernameInput.value.trim();
    if (!name) {
      loginError.textContent = "Enter a festive name.";
      return;
    }
    loginError.textContent = "";
    myId = genId();
    myName = name.substring(0, 20);

    const playerRef = ref(db, `christmasTriviaGame/players/${myId}`);
    await set(playerRef, { name: myName, score: 0, streak: 0 });
    onDisconnect(playerRef).remove();

    const managerRef = ref(db, "christmasTriviaGame/managerId");
    await runTransaction(managerRef, (current) => current || myId);

    loginCard.style.display = "none";
    mainLayout.style.display = "block";
  });

  usernameInput.addEventListener("keyup", (e) => {
    if (e.key === "Enter") joinBtn.click();
  });

  // ---- Reset game ----
  resetGameBtn.addEventListener("click", async () => {
    const sure = confirm("Reset the game for everyone? This clears players and questions.");
    if (!sure) return;

    try {
      await remove(gameRef);
      showToast("üéÑ Game reset. First player to join becomes the new manager.");
    } catch (err) {
      console.error("Error resetting game", err);
      showToast("Could not reset game. Check console for details.");
    }
  });

  // ---- Manager action helpers ----
  async function handleStartNext() {
    if (!isManager) return;

    await runTransaction(gameRef, (current) => {
      const now = Date.now();

      if (!current) {
        current = {
          players: {},
          managerId: myId,
          questionIndex: 0,
          questionActive: true,
          currentResponderId: null,
          questionEndsAt: now + 30000
        };
        return current;
      }

      if (current.questionIndex == null || current.questionIndex < 0) {
        current.questionIndex = 0;
        current.questionActive = true;
        current.currentResponderId = null;
        current.questionEndsAt = now + 30000;
        return current;
      }

      if (current.questionIndex < questions.length - 1) {
        current.questionIndex += 1;
        current.questionActive = true;
        current.currentResponderId = null;
        current.questionEndsAt = now + 30000;
        return current;
      }

      current.questionActive = false;
      current.currentResponderId = null;
      current.questionEndsAt = null;
      return current;
    });
    hideBuzzOverlay();
    playRandomSound('next');
  }

  async function handleCorrect() {
    if (!isManager) return;
    await runTransaction(gameRef, (current) => {
      if (!current || !current.currentResponderId) return current;
      const responderId = current.currentResponderId;
      const qIndex = current.questionIndex ?? 0;
      const q = questions[qIndex] || { points: 1 };
      current.players = current.players || {};
      const p = current.players[responderId];
      if (p) {
        p.score = (p.score || 0) + (q.points || 1);
        p.streak = (p.streak || 0) + 1;
      }
      current.questionActive = false;
      current.currentResponderId = null;
      current.questionEndsAt = null;
      return current;
    });
    hideBuzzOverlay();
    playRandomSound('correct');
  }

  async function handleIncorrect() {
    if (!isManager) return;
    await runTransaction(gameRef, (current) => {
      if (!current || !current.currentResponderId) return current;
      const responderId = current.currentResponderId;
      current.players = current.players || {};
      const p = current.players[responderId];
      if (p) p.streak = 0;
      current.currentResponderId = null;
      return current;
    });
    hideBuzzOverlay();
    playRandomSound('incorrect');
  }

  async function handleSkip() {
    if (!isManager) return;
    await runTransaction(gameRef, (current) => {
      if (!current) return current;
      current.questionActive = false;
      current.currentResponderId = null;
      current.questionEndsAt = null;
      return current;
    });
    hideBuzzOverlay();
    playRandomSound('next');
  }

  // ---- Buzz ----
  buzzBtn.addEventListener("click", async () => {
    if (!myId) return;
    buzzBtn.disabled = true;

    await runTransaction(ref(db, "christmasTriviaGame"), (current) => {
      if (!current || !current.questionActive) return current;
      if (current.currentResponderId) return current;
      current.currentResponderId = myId;
      return current;
    });
  });

  // ---- Manager actions: base buttons ----
  startNextBtn.addEventListener("click", handleStartNext);
  correctBtn.addEventListener("click", handleCorrect);
  incorrectBtn.addEventListener("click", handleIncorrect);
  skipBtn.addEventListener("click", handleSkip);

  // ---- Manager actions: overlay buttons ----
  overlayNextBtn.addEventListener("click", handleStartNext);
  overlayCorrectBtn.addEventListener("click", handleCorrect);
  overlayIncorrectBtn.addEventListener("click", handleIncorrect);
  overlaySkipBtn.addEventListener("click", handleSkip);
</script>
</body>
</html>
